---
name: memstore
description: 持久化对话记忆存储与检索。用于：写入对话摘要/用户偏好/项目状态/重要坑点，检索相关记忆注入 System Prompt。触发词："记住"、"回忆一下"。适用于需要长期上下文记忆的 Agent 流程。
---

# 持久化记忆（Rust 本地存储）

## 记忆管理思维框架

写入前问自己：
- **时效性**：1 天后还重要吗？1 个月后呢？
- **检索场景**：用户会在什么情境下需要这条记忆？
- **权重平衡**：高权重会长期占用检索槽位，是否值得？

检索后问自己：
- **时效验证**：是否已过期（技术版本、项目状态变更）？
- **事实核查**：向量检索基于语义相似度，不代表内容正确，必要时向用户确认
- **冲突处理**：多条记忆矛盾时，以时间最新或权重最高为准

## 快速决策

| 场景 | kind | weight | limit | 时机 |
|------|------|--------|-------|------|
| 对话摘要 | summary | 1.0 | - | 每轮结束自动执行 |
| 用户偏好 | profile | 2.5-3.0 | - | 用户说"记住我喜欢…" |
| 项目状态 | state | 2.0-2.5 | - | 关键进度/分支/配置变更 |
| 坑点/重要配置 | manual | 4.0-5.0 | - | 用户强调"这个很重要" |
| 自动注入 | - | - | 3 | 每次用户提问前 |
| 显式回忆 | - | - | 10-20 | 用户说"回忆一下…" |

**Weight 选择原则**：
- 1.0: 短期信息，几天后遗忘
- 2.0-3.0: 项目周期内有效
- 4.0+: 跨项目永久有效，谨慎使用（高权重会长期占据检索结果）

## 核心命令

```bash
# 写入
memstore add --kind <kind> --weight <weight> --text "<内容>" --path $PWD/.memory/memories.hnsw

# 检索
memstore search --query "<问题>" --limit <n> --path $PWD/.memory/memories.hnsw
```

## 资源

- **MANDATORY**: `scripts/memstore` - 二进制工具
- **可选**: `references/memory-format.md` - 存储格式细节
  - **仅在以下情况加载**：调试检索异常、替换向量生成器、用户询问存储原理
  - **Do NOT load**: 常规 add/search 操作

## 绝对不要 (NEVER)

- **NEVER** 同时运行多个 `memstore add` 进程
  - 当前实现无文件锁，并发写入会损坏 .hnsw 文件

- **NEVER** 手动编辑 .hnsw 二进制文件
  - bincode 序列化格式，手动修改会导致无法解析

- **NEVER** 对临时信息使用 weight > 3.0
  - 高权重会永久污染检索结果，只用于用户明确强调的持久偏好

- **NEVER** 无条件信任检索结果的内容
  - 向量检索基于语义相似度，不代表事实正确性
  - 用户可能记错了，或情况已发生变化
  - 始终将记忆作为"参考"而非"事实"，必要时向用户确认

- **NEVER** 在检索失败时静默忽略
  - 必须区分：文件不存在（首次使用）vs 索引损坏 vs 查询为空

## 错误处理

| 症状 | 原因 | 处理 |
|------|------|------|
| `No such file` | 目录不存在 | 先执行 `mkdir -p .memory` |
| 返回空数组 `[]` | 无匹配记忆或空库 | 正常情况，继续执行 |
| 解析错误/崩溃 | 文件损坏 | 备份并删除 `.memory/memories.hnsw`，重建索引 |
| 权限拒绝 | 文件被锁定 | 检查是否有其他进程在使用 |
| 检索结果明显不相关 | 向量模型变更/维度不匹配 | 阅读 `references/memory-format.md`，检查 `vector_dim` |
| 文件过大影响性能 | 记录过多（>10k 条）| 考虑按项目分库或清理过期记录 |

## 触发词映射

| 用户说 | 动作 |
|--------|------|
| "记住这个配置/坑/偏好" | 手动写入，weight >= 3.0 |
| "回忆一下/之前怎么做的" | 显式检索，limit=10-20 |
| "清空记忆/忘掉" | 删除 `.memory/memories.hnsw` |
| 普通问题 | 自动注入，limit=3 |

## 检索结果注入格式

将记忆拼接到 System Prompt 时，使用以下格式：

```
[历史记忆]
- <记忆内容 1>
- <记忆内容 2>
- <记忆内容 3>
[当前对话]
```
